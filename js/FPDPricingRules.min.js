/*
* Fancy Product Designer Pricing Rules 1.0.9 
* An Add-On for Fancy Product Designer. 
* Copyright 2017, Rafael Dery
*
* Only for the sale at the envato marketplaces
*/

var FPDPricingRules=function(t,l){"use strict";$=jQuery;var r=this,a=l.mainOptions.dynamicViewsOptions?l.mainOptions.dynamicViewsOptions.unit:"mm";this.doPricingRules=function(){l.pricingRulesPrice=0;var e=l.mainOptions.pricingRules;e&&0<e.length&&e.forEach(function(r){var n=[];"canvasSize"==r.property||"canvasArea"==r.property?n=l.viewInstances:void 0!==r.target.elements&&"#"===r.target.elements.charAt(0)?n.push(l.getElementByTitle(r.target.elements.replace("#",""),r.target.views)):n=void 0!==r.target.elements&&-1!==r.target.elements.search("custom")?l.getCustomElements(r.target.elements.replace("custom","").toLowerCase(),r.target.views,!1):l.getElements(r.target.views,r.target.elements,!1);var i,o=!1;-1!==["elementsLength","colorsLength"].indexOf(r.property)&&(o=!0),n.forEach(function(e,t){!e||o&&0<t||(e.hasOwnProperty("element")&&(e=e.element),"textLength"===r.property?i=e.text?e.text.replace(/\s/g,"").length:null:"linesLength"===r.property&&(i=e.text?e.text.split("\n").length:null),"fontSize"===r.property?i=e.text?e.fontSize:null:"imageSize"===r.property?i="image"===FPDUtil.getType(e.type)&&e.title?{width:e.width,height:e.height}:null:"imageSizeScaled"===r.property?i="image"===FPDUtil.getType(e.type)&&e.title?{width:e.width*e.scaleX,height:e.height*e.scaleY}:null:"canvasSize"===r.property?i={width:FPDUtil.pixelToUnit(e.options.stageWidth,a),height:FPDUtil.pixelToUnit(e.options.stageHeight,a)}:"canvasArea"===r.property||("pattern"===r.property?i=e.pattern:"elementsLength"===r.property?i=n.length:"colorsLength"===r.property&&(i=l.getUsedColors(r.target.views).length)),null!=i&&(r.rules.forEach(function(e){e.property=i}),"any"===r.type?r.rules.some(s):r.rules.forEach(s)))})});e=l.calculatePrice();t.trigger("priceChange",[null,e,l.singleProductPrice])};var s=function(e,t){return!!n(e.operator,e.property,e.value)&&("number"==typeof e.price&&(l.pricingRulesPrice+=e.price),!0)},n=function(t,r,n){if("object"!=typeof n)return o(t,r,n);var e=Object.keys(n),i=null;return e.forEach(function(e){!1!==i&&(i=o(t,r[e],n[e]))}),i},o=function(e,t,r){return"="===e?t===r:">"===e?r<t:"<"===e?t<r:">="===e?r<=t:"<="===e?t<=r:void 0};t.on("elementModify productCreate elementAdd elementRemove viewCreate viewRemove viewSizeChange _doPricingRules elementColorChange",function(e){l.productCreated&&r.doPricingRules()})};